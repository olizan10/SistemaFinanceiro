// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Usu√°rio do sistema
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Rela√ß√µes
  accounts             Account[]
  transactions         Transaction[]
  creditCards          CreditCard[]
  loans                Loan[]
  budgets              Budget[]
  goals                Goal[]
  receipts             Receipt[]
  thirdPartyLoans      ThirdPartyLoan[]
  fixedExpenses        FixedExpense[]
  cardDebts            CardDebt[]
  familyMembers        FamilyMember[]
  chatHistory          ChatHistory[]
  expenseCategories    ExpenseCategory[]
  variableExpenses     VariableExpense[]
  investments          Investment[]
  recurringTransactions RecurringTransaction[]
}

// Contas banc√°rias
model Account {
  id            String   @id @default(uuid())
  userId        String
  name          String
  type          String   // checking, savings, investment
  balance       Float    @default(0)
  currency      String   @default("BRL")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([userId])
}

// Cart√µes de cr√©dito
model CreditCard {
  id              String   @id @default(uuid())
  userId          String
  name            String
  lastFourDigits  String
  cardholderName  String?  // Nome do titular
  brand           String?  // Visa, Mastercard, etc.
  expiryDate      String?  // MM/YY
  limit           Float
  closingDay      Int      // Dia de fechamento da fatura
  dueDay          Int      // Dia de vencimento
  currentBalance  Float    @default(0)
  responsiblePerson String @default("eu") // eu, spouse, both
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    Transaction[]
  installments    Installment[]

  @@index([userId])
}

// Transa√ß√µes
model Transaction {
  id                String   @id @default(uuid())
  userId            String
  accountId         String?
  creditCardId      String?
  type              String   // income, expense, transfer
  category          String
  amount            Float
  description       String
  date              DateTime
  isPaid            Boolean  @default(false)
  isRecurring       Boolean  @default(false)
  recurringType     String?  // monthly, yearly, weekly
  responsiblePerson String   @default("eu") // eu, spouse, both
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  account       Account?     @relation(fields: [accountId], references: [id], onDelete: SetNull)
  creditCard    CreditCard?  @relation(fields: [creditCardId], references: [id], onDelete: SetNull)
  installment   Installment?

  @@index([userId])
  @@index([date])
}

// Parcelas (para compras parceladas)
model Installment {
  id             String   @id @default(uuid())
  creditCardId   String
  transactionId  String   @unique
  totalAmount    Float
  installments   Int
  currentInstall Int
  remainingAmount Float
  interestRate   Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  creditCard     CreditCard   @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  transaction    Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([creditCardId])
}

// Empr√©stimos
model Loan {
  id              String   @id @default(uuid())
  userId          String
  name            String
  principalAmount Float
  interestRate    Float
  remainingAmount Float
  monthlyPayment  Float
  startDate       DateTime
  endDate         DateTime
  status          String   // active, paid, defaulted
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Or√ßamentos
model Budget {
  id        String   @id @default(uuid())
  userId    String
  category  String
  amount    Float
  month     DateTime
  spent     Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, category, month])
}

// Metas financeiras
model Goal {
  id             String   @id @default(uuid())
  userId         String
  name           String
  targetAmount   Float
  currentAmount  Float    @default(0)
  deadline       DateTime
  status         String   // active, completed, cancelled
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Comprovantes (para OCR)
model Receipt {
  id          String   @id @default(uuid())
  userId      String
  imageUrl    String
  extractedData Json?
  amount      Float?
  date        DateTime?
  merchant    String?
  processed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Empr√©stimos com Terceiros (Agiotas)
model ThirdPartyLoan {
  id              String    @id @default(uuid())
  userId          String
  familyMemberId  String?   // Quem pegou emprestado
  creditorName    String    // Nome do credor
  creditorPhone   String?   // Telefone do credor
  principalAmount Float     // Valor emprestado
  monthlyInterest Float     // Taxa de juros mensal (ex: 10 = 10%)
  currentBalance  Float     // Saldo atual (com juros acumulados)
  startDate       DateTime  // Data do empr√©stimo
  nextPaymentDate DateTime? // Pr√≥ximo pagamento
  notes           String?   // Observa√ß√µes
  status          String    @default("active") // active, paid
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  familyMember    FamilyMember? @relation("FamilyMemberLoans", fields: [familyMemberId], references: [id], onDelete: SetNull)
  payments        ThirdPartyPayment[]

  @@index([userId])
}

// Pagamentos de Empr√©stimos com Terceiros
model ThirdPartyPayment {
  id              String    @id @default(uuid())
  thirdPartyLoanId String
  amount          Float
  paymentDate     DateTime
  notes           String?
  createdAt       DateTime  @default(now())

  thirdPartyLoan  ThirdPartyLoan @relation(fields: [thirdPartyLoanId], references: [id], onDelete: Cascade)

  @@index([thirdPartyLoanId])
}

// Contas Fixas (√Ågua, Luz, Internet, etc.)
model FixedExpense {
  id          String   @id @default(uuid())
  userId      String
  name        String   // Nome (√Ågua, Luz, Internet, G√°s)
  amount      Float    // Valor m√©dio
  dueDay      Int      // Dia do vencimento
  category    String   // utility, subscription, insurance
  isActive    Boolean  @default(true)
  lastPaidDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments    FixedExpensePayment[]

  @@index([userId])
}

// Hist√≥rico de pagamentos de contas fixas
model FixedExpensePayment {
  id             String   @id @default(uuid())
  fixedExpenseId String
  amount         Float
  paymentDate    DateTime
  notes          String?
  createdAt      DateTime @default(now())

  fixedExpense   FixedExpense @relation(fields: [fixedExpenseId], references: [id], onDelete: Cascade)

  @@index([fixedExpenseId])
}

// ============================================
// NOVO SISTEMA DE D√çVIDAS DE CART√ÉO
// ============================================

// D√≠vida de Cart√£o (agrupador)
model CardDebt {
  id              String   @id @default(uuid())
  userId          String
  cardholderName  String   // Nome do titular
  lastFourDigits  String   // 4 √∫ltimos d√≠gitos
  dueDay          Int      // Dia de vencimento da fatura
  totalDebt       Float    @default(0) // Total devedor (calculado)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchases       CardPurchase[]
  variableExpenses VariableExpense[]

  @@unique([userId, lastFourDigits])
  @@index([userId])
}

// Compra no cart√£o
model CardPurchase {
  id                String   @id @default(uuid())
  cardDebtId        String
  familyMemberId    String?  // Quem fez a compra
  description       String   // Descri√ß√£o da compra
  purchaseDate      DateTime // Data da compra
  totalAmount       Float    // Valor total da compra
  installments      Int      @default(1) // N√∫mero de parcelas
  installmentAmount Float    // Valor de cada parcela
  paidInstallments  Int      @default(0) // Parcelas j√° pagas
  cardFeePercent    Float    @default(0) // Taxa do cart√£o %
  status            String   @default("active") // active, paid
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  cardDebt          CardDebt      @relation(fields: [cardDebtId], references: [id], onDelete: Cascade)
  familyMember      FamilyMember? @relation(fields: [familyMemberId], references: [id], onDelete: SetNull)
  payments          CardPayment[]

  @@index([cardDebtId])
}

// Pagamento de parcela do cart√£o
model CardPayment {
  id             String   @id @default(uuid())
  cardPurchaseId String
  amount         Float
  feePaid        Float    @default(0) // Taxa paga
  paymentDate    DateTime
  createdAt      DateTime @default(now())

  cardPurchase   CardPurchase @relation(fields: [cardPurchaseId], references: [id], onDelete: Cascade)

  @@index([cardPurchaseId])
}

// ============================================
// SISTEMA MULTI-USU√ÅRIO
// ============================================

// Membros da fam√≠lia
model FamilyMember {
  id          String   @id @default(uuid())
  userId      String   // Usu√°rio principal
  name        String
  lastName    String
  email       String?
  canManage   Boolean  @default(false) // Pode gerenciar tudo?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchases   CardPurchase[]
  thirdPartyLoans ThirdPartyLoan[] @relation("FamilyMemberLoans")

  @@index([userId])
}

// ============================================
// CHAT COM MEM√ìRIA
// ============================================

// Hist√≥rico de conversas do chat
model ChatHistory {
  id        String   @id @default(uuid())
  userId    String
  role      String   // user, assistant
  content   String   @db.Text
  metadata  Json?    // Dados extras (a√ß√£o executada, etc)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// GASTOS VARI√ÅVEIS (Pontuais)
// ============================================

// Categorias de despesas (combust√≠vel, alimenta√ß√£o, etc)
model ExpenseCategory {
  id            String   @id @default(uuid())
  userId        String
  name          String   // Combust√≠vel, Alimenta√ß√£o, Transporte, Lazer
  iconEmoji     String   @default("üí∞")
  monthlyBudget Float?   // Or√ßamento mensal opcional
  color         String   @default("#8B5CF6")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  variableExpenses  VariableExpense[]

  @@unique([userId, name])
  @@index([userId])
}

// Gastos vari√°veis/pontuais
model VariableExpense {
  id          String   @id @default(uuid())
  userId      String
  categoryId  String
  description String
  amount      Float
  date        DateTime @default(now())
  paymentType String   // cartao, pix, dinheiro, debito
  cardDebtId  String?  // Se pago em cart√£o de cr√©dito
  isPaid      Boolean  @default(true) // Dinheiro/PIX = true, Cart√£o = depende
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  cardDebt    CardDebt?       @relation(fields: [cardDebtId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([categoryId])
  @@index([date])
}

// ============================================
// INVESTIMENTOS
// ============================================

model Investment {
  id              String   @id @default(uuid())
  userId          String
  name            String   // Nome do investimento
  type            String   // cdb, poupanca, acoes, cripto, tesouro, outros
  institution     String?  // Banco/corretora
  initialAmount   Float    // Valor inicial investido
  currentValue    Float    // Valor atual
  interestRate    Float?   // Taxa de rendimento %
  startDate       DateTime
  maturityDate    DateTime? // Data de vencimento (se houver)
  isActive        Boolean  @default(true)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// TRANSA√á√ïES RECORRENTES
// ============================================

model RecurringTransaction {
  id              String   @id @default(uuid())
  userId          String
  description     String
  amount          Float
  type            String   // expense, income
  categoryId      String?  // Categoria (se despesa)
  frequency       String   // monthly, weekly, yearly
  dayOfMonth      Int?     // Dia do m√™s (para monthly)
  dayOfWeek       Int?     // Dia da semana (para weekly)
  startDate       DateTime
  endDate         DateTime?
  lastProcessed   DateTime?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
