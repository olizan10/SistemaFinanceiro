// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Usuário do sistema
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  accounts      Account[]
  transactions  Transaction[]
  creditCards   CreditCard[]
  loans         Loan[]
  budgets       Budget[]
  goals         Goal[]
  receipts      Receipt[]
}

// Contas bancárias
model Account {
  id            String   @id @default(uuid())
  userId        String
  name          String
  type          String   // checking, savings, investment
  balance       Float    @default(0)
  currency      String   @default("BRL")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]

  @@index([userId])
}

// Cartões de crédito
model CreditCard {
  id              String   @id @default(uuid())
  userId          String
  name            String
  lastFourDigits  String
  limit           Float
  closingDay      Int      // Dia de fechamento da fatura
  dueDay          Int      // Dia de vencimento
  currentBalance  Float    @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions    Transaction[]
  installments    Installment[]

  @@index([userId])
}

// Transações
model Transaction {
  id            String   @id @default(uuid())
  userId        String
  accountId     String?
  creditCardId  String?
  type          String   // income, expense, transfer
  category      String
  amount        Float
  description   String
  date          DateTime
  isPaid        Boolean  @default(false)
  isRecurring   Boolean  @default(false)
  recurringType String?  // monthly, yearly, weekly
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  account       Account?     @relation(fields: [accountId], references: [id], onDelete: SetNull)
  creditCard    CreditCard?  @relation(fields: [creditCardId], references: [id], onDelete: SetNull)
  installment   Installment?

  @@index([userId])
  @@index([date])
}

// Parcelas (para compras parceladas)
model Installment {
  id             String   @id @default(uuid())
  creditCardId   String
  transactionId  String   @unique
  totalAmount    Float
  installments   Int
  currentInstall Int
  remainingAmount Float
  interestRate   Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  creditCard     CreditCard   @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  transaction    Transaction  @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([creditCardId])
}

// Empréstimos
model Loan {
  id              String   @id @default(uuid())
  userId          String
  name            String
  principalAmount Float
  interestRate    Float
  remainingAmount Float
  monthlyPayment  Float
  startDate       DateTime
  endDate         DateTime
  status          String   // active, paid, defaulted
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Orçamentos
model Budget {
  id        String   @id @default(uuid())
  userId    String
  category  String
  amount    Float
  month     DateTime
  spent     Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, category, month])
}

// Metas financeiras
model Goal {
  id             String   @id @default(uuid())
  userId         String
  name           String
  targetAmount   Float
  currentAmount  Float    @default(0)
  deadline       DateTime
  status         String   // active, completed, cancelled
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Comprovantes (para OCR)
model Receipt {
  id          String   @id @default(uuid())
  userId      String
  imageUrl    String
  extractedData Json?
  amount      Float?
  date        DateTime?
  merchant    String?
  processed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
